<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base</title>
    <script type="module">
        var fileNames = [];
        var hashedDigit = -1
        const contentDiv = document.getElementById("error-msg");
        async function fetchFileNames() {
            const response = await fetch(`/assets/detectionFiles.json`);
            fileNames = await response.json();
            loadContentFromHash();
        }

        function loadContentFromHash() {
            const hash = window.location.hash;


            if (hash) {
                if (hash === "") {
                    contentDiv.innerHTML = `# This is empty hash content the content`;
                } else if (/^\d+$/.test(hash.split('#/')[1])) {
                    hashedDigit = parseInt(hash.split('#/')[1]);
                    fetchJSONFiles(fileNames[hashedDigit])
                } else {
                    contentDiv.innerHTML = `# Unknown Hash
                                            This hash is not mapped to any content.`;
                }
            } else {
                contentDiv.innerHTML = `# Welcome No hash provided. Displaying default content.`;
            }
        }

        window.addEventListener('hashchange', loadContentFromHash);
        async function fetchJSONFiles(fileName) {
            const response = await fetch(`/assets/detectionFiles/${fileName}`);
            const data = await response.json();

            var fileTitle = document.getElementById("knowledge-base-file-title");
            fileTitle.innerText = data['Detection Name'];

            var fileTitle = document.getElementById("knowledge-base-file-title");
            fileTitle.innerText = data['Detection Name'];

            var detectionName = document.getElementById("knowledge-base-detection-name");
            detectionName.innerText = data['Detection Name'];

            var detectionDesc = document.getElementById("knowledge-base-description");
            detectionDesc.innerText = data['Description'];


            var detectionLog = document.getElementById("knowledge-base-logging-required");
            data['Logging Required'].forEach(log => {
                const li = document.createElement("li");
                const p = document.createElement("p");

                p.textContent = log;
                li.appendChild(p);
                detectionLog.appendChild(li);
            });

            var detectionRecommended = document.getElementById("knowledge-base-recommended-actions");
            data['Recommended Actions'].forEach(log => {
                const li = document.createElement("li");
                const p = document.createElement("p");

                p.textContent = log;
                li.appendChild(p);
                detectionRecommended.appendChild(li);
            });

            var detectionConsiderations = document.getElementById("knowledge-base-considerations");
            data.Considerations.forEach(log => {
                const li = document.createElement("li");
                const p = document.createElement("p");

                p.textContent = log;
                li.appendChild(p);
                detectionConsiderations.appendChild(li);
            });

            var detectionReferences = document.getElementById("knowledge-base-references");
            data.References.forEach(log => {
                const li = document.createElement("li");
                const p = document.createElement("p");

                p.textContent = log;
                li.appendChild(p);
                detectionReferences.appendChild(li);
            });

            var detectionAnnotations = document.getElementById("knowledge-base-annotations");
            data.Annotations.forEach(item => {
                const li = document.createElement('li');

                const key = Object.keys(item)[0];
                const value = item[key];

                var strong = document.createElement('strong');
                strong.textContent = key + ": ";
                li.appendChild(strong);
                if (['string', 'number'].includes(typeof value)) {
                    li.appendChild(document.createTextNode(value));
                } else {
                    value.forEach(subItem => {
                        if (['string', 'number'].includes(typeof subItem)) {
                            li.appendChild(document.createTextNode(subItem));
                        } else {
                            const a = document.createElement('a');
                            if (subItem.URL && subItem.URL !== 'None' && subItem.URL !== 'NONE') {
                                a.href = subItem.URL;
                            }
                            a.textContent = subItem[key] || subItem[key.replace(/.*\./, '')];
                            a.target = "_blank";
                            li.appendChild(a);
                            li.appendChild(document.createTextNode(' '));
                        }
                    });
                }

                detectionAnnotations.appendChild(li);
            });

            var detectionMitigations = document.getElementById("knowledge-base-mitigations");
            data.Mitigation.forEach(log => {
                const a = document.createElement('a');
                if (log.URL && log.URL !== 'None' && log.URL !== 'NONE') {
                    a.href = log.URL;
                }
                a.textContent = log.Mitigation;
                a.target = "_blank";
                const li = document.createElement("li");
                li.appendChild(a);
                li.appendChild(document.createTextNode(' '));
                detectionMitigations.appendChild(li);
            });

        }

        fetchFileNames();
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        #content {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div id="knowledge-base-file-content">
        <h2 id="knowledge-base-file-title"></h2>
        <h3>Detection Name</h3>
        <p id="knowledge-base-detection-name"></p>
        <h3>Description</h3>
        <p id="knowledge-base-description"></p>
        <h3>Annotations</h3>
        <ul id="knowledge-base-annotations">
        </ul>
        <h3>Type</h3>
        <p id="knowledge-base-type">TTP (Tactics, Techniques, and Procedures)</p>
        <h3>Logging Required</h3>
        <ul id="knowledge-base-logging-required">
        </ul>
        <h3>Recommended Actions</h3>
        <ul id="knowledge-base-recommended-actions">
        </ul>
        <h3>Considerations</h3>
        <ul id="knowledge-base-considerations">
        </ul>
        <h3>Mitigation</h3>
        <ul id="knowledge-base-mitigations">
        </ul>
        <h3>References:</h3>
        <ul id="knowledge-base-references">
        </ul>
    </div>

    <div id="error-msg"></div>
</body>

</html>